stages:
  - build
  - deploy_staging
  - release

# Job que construye los artefactos
build-job:
  stage: build
  tags:
    - GitLabRunner
  script:
    - mkdir -p dist
    - echo "Contenido del módulo" > dist/prueba_module.txt
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  only:
    - main

# Job que despliega a staging
deploy-staging:
  stage: deploy_staging
  tags:
    - GitLabRunner
  dependencies:
    - build-job
  environment:
    name: staging
  script:
    - echo "Desplegando en staging..."
    - ssh-keyscan -H "$ODOO_PRUEBAS_HOST" > known_hosts
    - sshpass -p "$ODOO_RRUEBAS_PASSWORD" scp -r -v -o UserKnownHostsFile=known_hosts dist/prueba_module.txt "$ODOO_PRUEBAS_USER@$ODOO_PRUEBAS_HOST:$DEST_PATH"
  only:
    - main

# Job que crea el release
release-job:
  stage: release
  tags: [GitLabRunner]

  variables:
    GITLAB_TOKEN: $RELEASE_CLI_TOKEN

  script:
    - echo "Creando release…"
  release:
    tag_name:    "v1.0.${CI_PIPELINE_ID}"
    name:        "Staging Release v1.0.${CI_PIPELINE_ID}"
    description: "Despliegue automático desde pipeline ${CI_PIPELINE_ID}"
    ref:         main
    assets:
      links:
        - name: "Descargar módulo"
          url:  "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts?file_type=archive"

  only:
    - main




# release-job:
#   stage: release
#   tags:
#     - GitLabRunner

#   script:
#     # 1) Notify
#     - echo "Creando release desde CI/CD"

#     # 2) POST to the Releases API with a here‑doc
#     - |
#       curl --fail --request POST \
#            --header "Content-Type: application/json" \
#            --header "JOB-TOKEN: $CI_JOB_TOKEN" \
#            --data @- "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" <<EOF
#       {
#         "name":        "Staging Release v1.0.${CI_PIPELINE_ID}",
#         "tag_name":    "v1.0.${CI_PIPELINE_ID}",
#         "description": "Despliegue automático a staging desde el pipeline ${CI_PIPELINE_ID}",
#         "ref":         "main",
#         "assets": {
#           "links": [
#             {
#               "name": "Descargar módulo",
#               "url":  "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts?file_type=archive"
#             }
#           ]
#         }
#       }
#       EOF

#   only:
#     - main



