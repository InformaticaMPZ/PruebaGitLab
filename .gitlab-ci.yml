stages:
  - build
  - deploy_test
  - deploy_production
  - deploy_test_job

# Job que construye los artefactos
build-job:
  stage: build
  tags:
    - GitLabRunner
  script:
    - mkdir dist && cp -r prueba_module dist/
  artifacts:
    paths:
      - dist/
    expire_in: 90 day
  only:
    refs:
      - dev
      - main
  # rules:
  #   - if: '$CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE != "schedule"'
  #   - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "schedule"'

# Job que despliega a testing (solo manual en rama dev)
deploy_test:
  stage: deploy_test
  tags:
    - GitLabRunner
  dependencies:
    - build-job
  environment:
    name: test
  script:
    - ssh-keyscan -H "$ODOO_HOST" > known_hosts
    - sshpass -p "$ODOO_PASSWORD" scp -r -v -o UserKnownHostsFile=known_hosts dist/prueba_module "$ODOO_USER@$ODOO_HOST:$ODOO_DEST_PATH"/temp
    - sshpass -p "$ODOO_PASSWORD" ssh -tt -o StrictHostKeyChecking=no "$ODOO_USER@$ODOO_HOST" "sudo -n /usr/bin/systemctl restart odoo"
    - sshpass -p "$ODOO_PASSWORD" ssh -tt -o StrictHostKeyChecking=no "$ODOO_USER@$ODOO_HOST" "
      sudo -n /usr/bin/systemctl status odoo --no-pager;
      if ! systemctl is-active --quiet odoo; then
        echo 'Odoo NO está corriendo en el servidor de pruebas';
        exit 1;
      fi"
  only:
    refs:
      - dev
  # rules:
  #   - if: '$CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE != "schedule"'

move-to-final-path:
  stage: deploy_test_job
  tags:
    - GitLabRunner
  dependencies:
    - deploy_test
  needs:
    - job: deploy_test
      artifacts: true
  environment:
    name: test
  script:
  - ssh-keyscan -H "$ODOO_HOST" > known_hosts
  - sshpass -p "$ODOO_PASSWORD" ssh -o UserKnownHostsFile=known_hosts "$ODOO_USER@$ODOO_HOST" "
      if [ -d '$ODOO_DEST_PATH/temp/prueba_module' ]; then
        echo '$ODOO_PASSWORD' | sudo -S mv '$ODOO_DEST_PATH/temp/prueba_module' '$ODOO_DEST_PATH/';
        if [ \$? -eq 0 ]; then
          echo 'Módulo movido con éxito a destino final';
          echo '$ODOO_PASSWORD' | sudo -S rm -rf '$ODOO_DEST_PATH/temp';
          echo 'Carpeta temp eliminada';
        else
          echo 'Error al mover el módulo';
          exit 1;
        fi
      else
        echo 'No se encontró el módulo en la carpeta temp';
        exit 1;
      fi"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

# Job que despliega a producción (automático en rama main)
deploy-production:
  stage: deploy_production
  tags:
    - GitLabRunner
  dependencies:
    - build-job
  environment:
    name: production
  script:
    - ssh-keyscan -H "$ODOO_HOST" > known_hosts
    - sshpass -p "$ODOO_PASSWORD" scp -r -v -o UserKnownHostsFile=known_hosts dist/prueba_module "$ODOO_USER@$ODOO_HOST:$ODOO_DEST_PATH/temp"
    
  release:
    tag_name: "${CI_PROJECT_NAME}-v1.0.${CI_PIPELINE_ID}"
    name: "Release: ${CI_PROJECT_NAME}-v1.0.${CI_PIPELINE_ID}"
    description: "Despliegue automático a staging desde el pipeline $CI_PIPELINE_ID"
    ref: "main"
    assets:
      links:
        - name: "Descargar módulo"
          url: "$CI_PROJECT_URL/-/jobs/$((CI_JOB_ID-1))/artifacts/download?file_type=archive"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "schedule"'
