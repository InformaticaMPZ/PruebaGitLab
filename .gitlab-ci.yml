stages:
  - build
  - deploy
  - release

# Job que construye los artefactos
build-job:
  stage: build
  tags:
    - GitLabRunner
  script:
    - mkdir dist && cp -r prueba_module dist/
  artifacts:
    paths:
      - dist/
    expire_in: 90 day
  only:
    refs:
      - main
      - dev

deploy-job:
  stage: deploy  # o deploy_production si quieres agruparlo ahí
  tags:
    - GitLabRunner
  dependencies:
    - build-job
  environment:
    name: $DEPLOY_ENVIRONMENT  # Será "test" o "production" dependiendo de la rama
  script:
    - |
      echo "Desplegando a entorno: $DEPLOY_ENVIRONMENT"
      ssh-keyscan -H "$ODOO_HOST" > known_hosts
      sshpass -p "$ODOO_PASSWORD" scp -r -v -o UserKnownHostsFile=known_hosts dist/prueba_module "$ODOO_USER@$ODOO_HOST:$DEST_PATH"
      sshpass -p "$ODOO_PASSWORD" ssh -tt -o StrictHostKeyChecking=no "$ODOO_USER@$ODOO_HOST" "sudo -n /usr/bin/systemctl restart odoo"
      sshpass -p "$ODOO_PASSWORD" ssh -tt -o StrictHostKeyChecking=no "$ODOO_USER@$ODOO_HOST" "
        sudo -n /usr/bin/systemctl status odoo --no-pager;
        if ! systemctl is-active --quiet odoo; then
          echo 'Odoo NO está corriendo en $DEPLOY_ENVIRONMENT';
          exit 1;
        fi"
  only:
    refs:
      - dev
      - main
  when: manual
  before_script:
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        export DEPLOY_ENVIRONMENT="production"
      elif [ "$CI_COMMIT_REF_NAME" = "dev" ]; then
        export DEPLOY_ENVIRONMENT="test"
      else
        echo "Rama no válida para despliegue"
        exit 1
      fi

# Job que crea el release (solo en dev)
release-job:
  stage: release
  tags:
    - GitLabRunner
  dependencies:
    - deploy-job
  script:
    - echo "Creando release desde CI/CD"
  release:
    tag_name: "${CI_PROJECT_NAME}-v1.0.${CI_PIPELINE_ID}"
    name: "Release: v1.0.$CI_PIPELINE_ID"
    description: "Despliegue automático a staging desde el pipeline $CI_PIPELINE_ID"
    ref: "main"
    assets:
      links:
        - name: "Descargar módulo"
          url: "$CI_PROJECT_URL/-/jobs/$((CI_JOB_ID-1))/artifacts/download?file_type=archive"
  only:
    refs:
      - main


